<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML+RDFa 1.0//EN"
  "http://www.w3.org/MarkUp/DTD/xhtml-rdfa-1.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" version="XHTML+RDFa 1.0" dir="ltr"
  xmlns:content="http://purl.org/rss/1.0/modules/content/"
  xmlns:dc="http://purl.org/dc/terms/"
  xmlns:foaf="http://xmlns.com/foaf/0.1/"
  xmlns:og="http://ogp.me/ns#"
  xmlns:rdfs="http://www.w3.org/2000/01/rdf-schema#"
  xmlns:sioc="http://rdfs.org/sioc/ns#"
  xmlns:sioct="http://rdfs.org/sioc/types#"
  xmlns:skos="http://www.w3.org/2004/02/skos/core#"
  xmlns:xsd="http://www.w3.org/2001/XMLSchema#">

<head profile="http://www.w3.org/1999/xhtml/vocab">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="shortcut icon" href="BEAST_favicon.ico" type="image/vnd.microsoft.icon" />
<link rel="shortlink" href="57.html" />
<link rel="canonical" href="continuous-phylogeographic-analysis.html" />
<meta name="Generator" content="Drupal 7 (http://drupal.org)" />
  <title>Continuous phylogeographic analysis | BEAST</title>
  <style type="text/css" media="all">
@import url("system.base.css%3Fou07bk.css");
@import url("system.menus.css%3Fou07bk.css");
@import url("system.messages.css%3Fou07bk.css");
@import url("system.theme.css%3Fou07bk.css");
</style>
<style type="text/css" media="all">
@import url("field.css%3Fou07bk.css");
@import url("node.css%3Fou07bk.css");
@import url("search.css%3Fou07bk.css");
@import url("user.css%3Fou07bk.css");
@import url("ckeditor.css%3Fou07bk.css");
</style>
<style type="text/css" media="all">
@import url("style.css%3Fou07bk.css");
</style>
<style type="text/css" media="print">
@import url("print.css%3Fou07bk.css");
</style>

<!--[if lt IE 7]>
<link type="text/css" rel="stylesheet" href="http://sbsweb2-bak.bio.ed.ac.uk/beast/themes/garland/fix-ie.css?ou07bk" media="all" />
<![endif]-->
  <script type="text/javascript" src="jquery.js%3Fv=1.4.4"></script>
<script type="text/javascript" src="jquery.once.js%3Fv=1.2"></script>
<script type="text/javascript" src="drupal.js%3Fou07bk"></script>
<script type="text/javascript">
<!--//--><![CDATA[//><!--
jQuery.extend(Drupal.settings, {"basePath":"\/beast\/","pathPrefix":"","ajaxPageState":{"theme":"garland","theme_token":"12jc6PALQwaPKDqJtnPHtOVutKS4Fx8_l0hO8vHdOUo","js":{"misc\/jquery.js":1,"misc\/jquery.once.js":1,"misc\/drupal.js":1},"css":{"modules\/system\/system.base.css":1,"modules\/system\/system.menus.css":1,"modules\/system\/system.messages.css":1,"modules\/system\/system.theme.css":1,"modules\/field\/theme\/field.css":1,"modules\/node\/node.css":1,"modules\/search\/search.css":1,"modules\/user\/user.css":1,"sites\/all\/modules\/ckeditor\/css\/ckeditor.css":1,"themes\/garland\/style.css":1,"themes\/garland\/print.css":1,"themes\/garland\/fix-ie.css":1}}});
//--><!]]>
</script>
</head>
<body class="html not-front not-logged-in no-sidebars page-node page-node- page-node-57 node-type-article fluid-width" >
  <div id="skip-link">
    <a href="Continuous-phylogeographic-analysis.html#main-content" class="element-invisible element-focusable">Skip to main content</a>
  </div>
      
  <div id="wrapper">
    <div id="container" class="clearfix">

      <div id="header">
        <div id="logo-floater">
                              <div id="branding"><strong><a href="index.html">
                          <img src="beast.png" alt="BEAST " title="BEAST " id="logo" />
                        <span>BEAST</span>            </a></strong></div>
                          </div>

        <h2 class="element-invisible">Main menu</h2><ul class="links inline main-menu"><li class="menu-230 first"><a href="index.html">Home</a></li>
<li class="menu-307"><a href="programs.html">Programs</a></li>
<li class="menu-329"><a href="downloads.html">Downloads</a></li>
<li class="menu-312"><a href="tutorials.html" title="Tutorials and documentation on using BEAST">Tutorials</a></li>
<li class="menu-326"><a href="error-messages.html">Error Messages</a></li>
<li class="menu-313 last"><a href="faq.html" title="Frequently Asked Questions">FAQ</a></li>
</ul>              </div> <!-- /#header -->

      
      <div id="center"><div id="squeeze"><div class="right-corner"><div class="left-corner">
          <h2 class="element-invisible">You are here</h2><div class="breadcrumb"><a href="index.html">Home</a></div>                    <a id="main-content"></a>
          <div id="tabs-wrapper" class="clearfix">                                <h1 class="with-tabs">Continuous phylogeographic analysis</h1>
                              </div>                                                  <div class="clearfix">
            <div id="node-57" class="node node-article node-promoted" about="/beast/continuous-phylogeographic-analysis" typeof="sioc:Item foaf:Document">

  
      <span property="dc:title" content="Continuous phylogeographic analysis" class="rdf-meta element-hidden"></span>
      <span class="submitted"><span property="dc:date dc:created" content="2015-01-29T07:25:29+00:00" datatype="xsd:dateTime" rel="sioc:has_creator">Thu, 01/29/2015 - 07:25 — <span class="username" xml:lang="" about="/beast/users/rambaut" typeof="sioc:UserAccount" property="foaf:name" datatype="">rambaut</span></span></span>
  
  <div class="content clearfix">
    <div class="field field-name-body field-type-text-with-summary field-label-hidden"><div class="field-items"><div class="field-item even" property="content:encoded"><h1> </h1>
<div id="bodyContent" style="color: rgb(0, 0, 0); font-family: sans-serif; line-height: 19.049999237060547px;">
<h2>Setting up a standard continuous phylogeographic analysis </h2>
<p>This tutorial describes how to edit a BEAST XML file to set up a phylogeographic analysis in continuous space using a standard random walk<a class="external autonumber" href="https://web.archive.org/web/20120903075509/http://en.wikipedia.org/wiki/Random_walk" rel="nofollow" style="text-decoration: none; color: rgb(51, 102, 187); background-image: url(https://web.archive.org/web/20120722155546/http://beast.bio.ed.ac.uk/w/skins/monobook/external.png); padding: 0px 13px 0px 0px; background-position: 100% 50%; background-repeat: no-repeat no-repeat;" title="http://en.wikipedia.org/wiki/Random_walk">[1]</a>. The tutorial assumes you are using BEASTv1.5.4 or higher. The example XML file for this analysis can be found here <a class="external autonumber" href="https://web.archive.org/web/20120903075509/http://code.google.com/p/beast-mcmc/source/browse/trunk/examples/release/Phylogeography/continuous/RacRABV_homogeneous.xml" rel="nofollow" style="text-decoration: none; color: rgb(51, 102, 187); background-image: url(https://web.archive.org/web/20120722155546/http://beast.bio.ed.ac.uk/w/skins/monobook/external.png); padding: 0px 13px 0px 0px; background-position: 100% 50%; background-repeat: no-repeat no-repeat;" title="http://code.google.com/p/beast-mcmc/source/browse/trunk/examples/release/Phylogeography/continuous/RacRABV_homogeneous.xml">[2]</a> and considers raccoon rabies diffusion in north-eastern United States <a class="external autonumber" href="https://web.archive.org/web/20120903075509/http://www.ncbi.nlm.nih.gov/pubmed/17470818" rel="nofollow" style="text-decoration: none; color: rgb(51, 102, 187); background-image: url(https://web.archive.org/web/20120722155546/http://beast.bio.ed.ac.uk/w/skins/monobook/external.png); padding: 0px 13px 0px 0px; background-position: 100% 50%; background-repeat: no-repeat no-repeat;" title="http://www.ncbi.nlm.nih.gov/pubmed/17470818">[3]</a>. This tutorial sets up a standard random walk; for relaxed random walks (RRWs, <a class="external autonumber" href="https://web.archive.org/web/20120903075509/http://www.ncbi.nlm.nih.gov/pubmed/20203288" rel="nofollow" style="text-decoration: none; color: rgb(51, 102, 187); background-image: url(https://web.archive.org/web/20120722155546/http://beast.bio.ed.ac.uk/w/skins/monobook/external.png); padding: 0px 13px 0px 0px; background-position: 100% 50%; background-repeat: no-repeat no-repeat;" title="http://www.ncbi.nlm.nih.gov/pubmed/20203288">[4]</a>), we refer to a separate tutorial. First, we need to add the 2D locations as continuous "traits" to the tips. Latitude and longitude can be specified as a bivariate taxon attribute, in this case named "location". Although any order can be used as long as it is the same for all taxa, it would be useful to a stick to a latitude-longitude order for the sake of consistency:</p>
<pre>
	&lt;taxa id="taxa"&gt;
		&lt;taxon id="hOH10_97.2_41.053_80.706"&gt;
			&lt;date value="1997.2" direction="forwards" units="years"/&gt;
			&lt;attr name="location"&gt;41.053 -80.706&lt;/attr&gt;
		&lt;/taxon&gt;
		&lt;taxon id="hWVa01_93.2_40.505_80.575"&gt;
			&lt;date value="1993.2" direction="forwards" units="years"/&gt;
			&lt;attr name="location"&gt;40.505 -80.575&lt;/attr&gt;
		&lt;/taxon&gt;
		.
		.
		.
		&lt;taxon id="WVa22_02.7_39.635_79.995"&gt;
			&lt;date value="2002.7" direction="forwards" units="years"/&gt;
			&lt;attr name="location"&gt;39.635 -79.995&lt;/attr&gt;
		&lt;/taxon&gt;
	&lt;/taxa&gt;
</pre><p>Note that with the standard angular specification of latitude and longitude, we assume that phylogeographic diffusion occurs within a rectangle defined by -90,+90 latitude borders and -180,180 longitude borders.</p>
<p>Under a time-homogeneous spatial diffusion process, the additional parameters we must estimate are the unobserved locations of the sequence ancestors at all times along the phylogeny. Therefore, add the four nodeTraits elements to the treemodel (one for the rootTrait, the internalTraits, the leafTraits and a collection of allTraits):</p>
<pre>
	&lt;treeModel id="treeModel"&gt;
		&lt;coalescentTree idref="startingTree"/&gt;
		&lt;rootHeight&gt;
			&lt;parameter id="treeModel.rootHeight"/&gt;
		&lt;/rootHeight&gt;
		&lt;nodeHeights internalNodes="true"&gt;
			&lt;parameter id="treeModel.internalNodeHeights"/&gt;
		&lt;/nodeHeights&gt;
		&lt;nodeHeights internalNodes="true" rootNode="true"&gt;
			&lt;parameter id="treeModel.allInternalNodeHeights"/&gt;
		&lt;/nodeHeights&gt;
		&lt;nodeTraits name="location" rootNode="true" internalNodes="false" leafNodes="false" traitDimension="2"&gt;
			&lt;parameter id="rootTrait"/&gt;
		&lt;/nodeTraits&gt; 
		&lt;nodeTraits name="location" rootNode="true" internalNodes="true" leafNodes="false" traitDimension="2"&gt;
			&lt;parameter id="internalTraits"/&gt;
		&lt;/nodeTraits&gt;
		&lt;nodeTraits name="location" rootNode="false" internalNodes="false" leafNodes="true" traitDimension="2"&gt;
			&lt;parameter id="leafTraits"/&gt;
		&lt;/nodeTraits&gt;
		&lt;nodeTraits name="location" rootNode="true" internalNodes="true" leafNodes="true" traitDimension="2"&gt;
			&lt;parameter id="allTraits"/&gt;
		&lt;/nodeTraits&gt;
	&lt;/treeModel&gt;
</pre><p>Sufficient statistics of the continuous process are the unobserved 2D locations at the root and internal nodes, and the infinitesimal precision matrix for a bivariate diffusion. Add a multivariateDiffusionModel (after the treeLikelihood is a good place), with the bivariate precision matrix:</p>
<pre>
	&lt;multivariateDiffusionModel id="diffusionModel"&gt;
		&lt;precisionMatrix&gt;
			&lt;matrixParameter id="precisionMatrix"&gt;
				&lt;parameter id="col1" value="0.05 0.002"/&gt;
				&lt;parameter id="col2" value="0.002 0.05"/&gt;
			&lt;/matrixParameter&gt;
		&lt;/precisionMatrix&gt;
	&lt;/multivariateDiffusionModel&gt;
</pre><p>The diagonal elements of the precision matrix are the two strictly nonnegative marginal precisions in each spatial dimension. The off-diagonal elements determine the correlation, which can be obtained by the correlation statistic (see below). Following the multivariateDiffusionModel, we specify a multivariateWishartPrior over the precision matrix:</p>
<pre>
	&lt;multivariateWishartPrior id="precisionPrior" df="2"&gt;
		&lt;scaleMatrix&gt;
			&lt;matrixParameter&gt;
				&lt;parameter value="1.0 0.0"/&gt;
				&lt;parameter value="0.0 1.0"/&gt;
			&lt;/matrixParameter&gt;
		&lt;/scaleMatrix&gt;
		&lt;data&gt;
			&lt;matrixParameter idref="precisionMatrix"/&gt;
		&lt;/data&gt;
	&lt;/multivariateWishartPrior&gt;
</pre><p>The Wishart distribution is a multivariate generalization of the gamma distribution and is characterized by a “degrees of freedom” (df="2") and scale matrix. Without further expert knowledge, we set these hyperparameters, such that the precisions are relatively uninformative. For the the root location, we specify a multivariateNormalPrior:</p>
<pre>
	 &lt;multivariateNormalPrior id="rootPrior"&gt;
	   &lt;meanParameter&gt;
		 &lt;parameter value="0.0 0.0"/&gt;
		   &lt;/meanParameter&gt;
	   	&lt;precisionParameter&gt;
	 		&lt;matrixParameter&gt;
	   			&lt;parameter value="0.001 0.0"/&gt;
	   			&lt;parameter value="0.0 0.001"/&gt;
	 		&lt;/matrixParameter&gt;
	   	&lt;/precisionParameter&gt;
	  	&lt;data&gt;
	 		&lt;parameter idref="rootTrait"/&gt;
	  	&lt;/data&gt;
	 &lt;/multivariateNormalPrior&gt;
</pre><p>
Note that the prior expectation for the root is (0,0), but again in the absence of strong preexisting knowledge, we make the prior uninformative by granting it a large variance (with small precisions of 0.001). We complete the continuous model specification by setting up a Brownian diffusion likelihood:</p>
<pre>
	&lt;multivariateTraitLikelihood id="traitLikelihood" traitName="location" 
	 						     useTreeLength="true" scaleByTime="true" 
                                 reportAsMultivariate="true"&gt;
		&lt;multivariateDiffusionModel idref="diffusionModel"/&gt;
		&lt;treeModel idref="treeModel"/&gt;
		&lt;traitParameter&gt;
			&lt;parameter idref="allTraits"/&gt;
		&lt;/traitParameter&gt;
		&lt;randomize upper="45 -70" lower="28 -122"&gt;
			&lt;parameter idref="internalTraits"/&gt;
		&lt;/randomize&gt;
		&lt;!-- a jitter adds random noise uniformily drawn from a particular window size for each dimension in case there are duplicate traits --&gt;
		&lt;!--
		&lt;jitter window="0.5 0.5" duplicatesOnly="true"&gt;
			&lt;parameter idref="leafTraits"/&gt;
		&lt;/jitter&gt;
		--&gt;
    &lt;/multivariateTraitLikelihood&gt;
</pre><p>In this multivariateTraitLikelihood, we can specify starting values for the locations at the internal nodes that are randomly drawn from a uniform distribution, in this case uniform(28,45) and uniform(-122,-70) for latitude and longitude respectively. As the case here, the boundaries can be set according to the distribution of 2D locations at the tips. The jitter element is commented out, but can be used to add random noise from a fixed window (here with size 0.5 for both latitude and longitude) to the duplicate traits at the tips of the tree. This is strongly recommended when resorting to <a href="https://web.archive.org/web/20120903075509/http://beast.bio.ed.ac.uk/RRWs" style="text-decoration: none; color: rgb(90, 54, 150); background-image: none; background-position: initial initial; background-repeat: initial initial;" title="RRWs">RRWs</a>. Each sequence has a unique location in this data set, so there are no duplicate traits in this case.</p>
<p>Additional statistics can be included to obtain useful summaries of the diffusion proces:</p>
<pre>
	&lt;correlation id="locationCorrelation" dimension1="1" dimension2="2"&gt;
		&lt;matrixParameter idref="precisionMatrix"/&gt;
	&lt;/correlation&gt;

	&lt;treeLengthStatistic id="treeLength"&gt;
		&lt;treeModel idref="treeModel"/&gt;
	&lt;/treeLengthStatistic&gt;

	&lt;productStatistic id="treeLengthPrecision1"&gt;
		&lt;treeLengthStatistic idref="treeLength"/&gt;
		&lt;subStatistic id="precision1" dimension="0"&gt; 
			&lt;parameter idref="col1"/&gt;
		&lt;/subStatistic&gt;
	&lt;/productStatistic&gt;

	&lt;productStatistic id="treeLengthPrecision2"&gt;
		&lt;treeLengthStatistic idref="treeLength"/&gt;
		&lt;subStatistic id="precision2" dimension="1"&gt;
			&lt;parameter idref="col2"/&gt;
		&lt;/subStatistic&gt;
	&lt;/productStatistic&gt;

	&lt;treeDispersionStatistic id="diffusionRate" greatCircleDistance="true"&gt;
		&lt;treeModel idref="treeModel"/&gt;
		&lt;multivariateTraitLikelihood idref="traitLikelihood"/&gt;
	&lt;/treeDispersionStatistic&gt;
</pre><p>These include a standard correlation between longitude and latitude and a tree length statistic that is subsequently used in two productStatistics. The precision matrix scales arbitrarily in units-time. We measure the precision matrix in units-tree-length (see useTreeLength="true" scaleByTime="true" in multivariateTraitLikelihood) to maintain data likelihood identifiability. The productStatistics return the original precisions before rescaling. Finally a treeDispersionStatistic sumarizes the overall rate of diffusion throughout the tree. This is calculated as the total distance travelled accross the tree divided by the total tree length in time units. The distances for each branch are inferred from the location realizations at the parent and descendent node of the branches (in this case in great-circle distances <a class="external autonumber" href="https://web.archive.org/web/20120903075509/http://en.wikipedia.org/wiki/Great-circle_distance" rel="nofollow" style="text-decoration: none; color: rgb(51, 102, 187); background-image: url(https://web.archive.org/web/20120722155546/http://beast.bio.ed.ac.uk/w/skins/monobook/external.png); padding: 0px 13px 0px 0px; background-position: 100% 50%; background-repeat: no-repeat no-repeat;" title="http://en.wikipedia.org/wiki/Great-circle_distance">[5]</a>). Beware that the great-circle distance calculations assume that the 2D locations were entered in latitude-longitude order!</p>
<p>The Wishart distribution is conjugate to the BD likelihood, enabling us to construct a Gibbs sampler from the full-condition distribution of the precision matrix (precisionGibbsOperator). Because we assume a multivariate normal prior on the root, the full-conditional distributions for the root and internal node locations remain multivariate normally distributed under a Brownian diffusion process, allowing us to construct a Gibbs sampler for internal node locations. These samplers are added under the operators:</p>
<pre>
	&lt;operators id="operators" optimizationSchedule="log"&gt;
		.
		.
		.
		&lt;precisionGibbsOperator weight="15"&gt;
			&lt;multivariateTraitLikelihood idref="traitLikelihood"/&gt;
			&lt;multivariateWishartPrior idref="precisionPrior"/&gt;
		&lt;/precisionGibbsOperator&gt;

		&lt;traitGibbsOperator weight="50"&gt;
			&lt;multivariateTraitLikelihood idref="traitLikelihood"/&gt;
			&lt;multivariateNormalPrior idref="rootPrior"/&gt;
		&lt;/traitGibbsOperator&gt;
		
    		&lt;randomWalkOperator windowSize="10.0" weight="5"&gt;
			&lt;parameter idref="rootTrait"/&gt;
		&lt;/randomWalkOperator&gt;
	&lt;/operators&gt;
</pre><p>The randomWalkOperator on the rootTrait is not a necessity, but could assist in efficient mixing. The two priors specified above need to be included in the prior block:</p>
<pre>
			&lt;prior id="prior"&gt;
				&lt;oneOnXPrior&gt;
					&lt;parameter idref="hky.kappa"/&gt;
				&lt;/oneOnXPrior&gt;
				&lt;generalizedSkyLineLikelihood idref="skyline"/&gt;
				&lt;exponentialMarkovLikelihood idref="eml1"/&gt;
				&lt;multivariateNormalPrior idref="rootPrior"/&gt;
				&lt;multivariateWishartPrior idref="precisionPrior"/&gt;
			&lt;/prior&gt;
</pre><p>Adding the Brownian diffusion likelihood to the likelihood block accomplishes the joint inference of sequences and tip traits:</p>
<pre>
			&lt;likelihood id="likelihood"&gt;
				&lt;treeLikelihood idref="treeLikelihood"/&gt;
				&lt;multivariateTraitLikelihood idref="traitLikelihood"/&gt; 
			&lt;/likelihood&gt;
</pre><p>Add the parameters (precisionMatrix, rootTrait), statistics (diffusionRate, productStatistics and correlation), and multivariateTraitLikelihood to the fileLog.</p>
<pre>
			
		&lt;log id="fileLog" logEvery="50000" fileName="RacRABV_homogeneous.log"&gt;
			.
			.
			.
			&lt;matrixParameter idref="precisionMatrix"/&gt;
			&lt;parameter idref="rootTrait"/&gt;
			&lt;treeDispersionStatistic idref="diffusionRate"/&gt;
			&lt;productStatistic idref="treeLengthPrecision1"/&gt;
			&lt;productStatistic idref="treeLengthPrecision2"/&gt;
			&lt;treeDispersionStatistic idref="diffusionRate"/&gt;
 			&lt;correlation idref="locationCorrelation"/&gt;
 			&lt;multivariateTraitLikelihood idref="traitLikelihood"/&gt;
		&lt;/log&gt;
</pre><p>Finally, to annotate the trees in the posterior distribution with the sampled continuous locations at each node, we need to add the multivariateTraitLikelihood to the logTree element. Including also the multivariateDiffusionModel will report additional information that may potentially be useful:</p>
<pre>
		&lt;logTree id="treeFileLog" logEvery="50000" nexusFormat="true" fileName="RacRABV_homogeneous.trees" sortTranslationTable="true"&gt;
			&lt;treeModel idref="treeModel"/&gt;
			&lt;posterior idref="posterior"/&gt;
			&lt;multivariateDiffusionModel idref="diffusionModel"/&gt;   &lt;!-- reports info about diffusion model --&gt;
			&lt;multivariateTraitLikelihood idref="traitLikelihood"/&gt;
		&lt;/logTree&gt;</pre><p> </p>
</div>
</div></div></div>  </div>

  <div class="clearfix">
          <div class="links"></div>
    
      </div>

</div>
          </div>
                          </div></div></div></div> <!-- /.left-corner, /.right-corner, /#squeeze, /#center -->

      
    </div> <!-- /#container -->
  </div> <!-- /#wrapper -->
  </body>
</html>
